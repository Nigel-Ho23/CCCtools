---
title: "Running CellPhoneDB in R"
output: github_document
date: "2025-08-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

CellPhoneDB is a popular **Python** package developed by [Teichmann Lab](https://www.teichlab.org/), and currently managed and further developed by the [Vento-Tormo Lab](https://ventolab.org/) from CellPhoneDB version 3. It is a useful cell-cell communication tool to directly look up interactions of interest from single-cell multiomics data, with their database of only manually curated and reviewed HUMAN interactions. 

A key feature of CellPhoneDB is its inherent function of accounting for heteromeric complexes by decomplexifying to their subunits and ensuring that expression of all subunits have to be non-zero and above a user-defined threshold to be considered present in the interaction. This accurately recapitulates how interactions can occur in vivo. As such, we thought to incorporate CellPhoneDB with another popular cell-cell communication tool, CellChat, that shares the same feature.

# Setting up required environment

As mentioned in the **Introduction**, CellPhoneDB is a Python package and currently, does not have an R equivalent. Here, we provide a wrapper function `run_cellphonedb()` for running CellPhoneDB completely within R. To do this, we require the use of the `reticulate` package (a dependency in CCCtools) and provide users with the `cpdb.yaml` file for creating the CellPhoneDB python environment in R. In addition to the `cpdb.yaml` file, the CellPhoneDB interaction database `cellphonedb.zip` is also **required** for running CellPhoneDB analysis; you may find the environment file and database in the same directory for download [**here**](../data/).

## CellPhoneDB conda environment in R

### R set-up

```{r}
pacman::p_load_gh("nigelhojinker/CCCtools")
setwd(this.path::here())
rm(list = ls())
```

### Set up conda & python via reticulate

For users **without** a prior conda installation, you may run the line below for installation of miniconda:

```{r, eval = FALSE}
if(!file.exists(conda_binary())) install_miniconda()
```

For users **with** conda installed, we recommend running the line below to ensure that the correct conda is selected and used by `reticulate`. 
Of course, users should input the path to conda in their respective local machines.

```{r}
options(reticulate.conda_binary = "C:/Users/hojkn/AppData/Local/miniforge3/condabin/conda.bat")
```

Once installation and conda selection is complete, we can confirm this by running:

```{r}
conda_binary()
```

Next, we have to create the CellPhoneDB conda environment with the necessary Python modules for running the analysis.
This is done **only once:**

```{r, eval = FALSE}
conda_create(envname = "cpdb", environment = "/path/to/cpdb.yaml")
```

Once the cpdb environment has been created, we have to select its python interpreter:

```{r}
python_binary <- conda_list() %>%
  filter(name == "cpdb") %>%
  pull(python) %>%
  normalizePath(winslash = "/")

python_binary

use_python(python_binary, required = TRUE)
```

# Running CellPhoneDB

Now, we are ready to run CellPhoneDB in R.

We provide the `run_cellphonedb()` function that can give us output from CellPhoneDB analysis (method 2).
This function takes in a Seurat object with normalized counts in the data layer of the RNA assay, and annotated cell type labels in the meta.data. Here is a breakdown of the other parameters in `run_cellphonedb()`:

- labels: meta.data column name for the annotated cell type labels
- cpdbPath: /path/to/cellphonedb.zip
- metaPath: /path/to/meta.tsv; path to the tsv file and the tsv file itself will be created internally, there is no need to make the file path before running this function
- adataPath /path/to/normcounts.h5ad; function creates an AnnData object internally and save it to the user-defined path. Similar to metaPath, users do not have to create the file path before running the function
- outPath: /path/to/outputs; five .txt files will be generated in every run and saved in this directory (creation prior to run is not needed)

You may see [here](../R/run_cellphonedb.R) for full details of `run_cellphonedb()`.

```{r}
# Load your Seurat object
data(seu.NL)

seu.NL

seu.NL@meta.data %>% head()
```

```{r, eval = FALSE}

run_cellphonedb(obj = seu.NL,
                labels = "labels",
                cpdbPath  = "../data/cellphonedb.zip",
                metaPath  = "../data/cpdb/NL_meta.tsv",
                adataPath = "../data/cpdb/NL.h5ad",
                outPath   = "../data/cpdb/NL")

# Reading user files...
# The following user files were loaded successfully:
# ../data/cpdb/NL.h5ad
# ../data/cpdb/NL_meta.tsv
# [ ][CORE][06/08/25-17:07:51][INFO] [Cluster Statistical Analysis] Threshold:0.1 Iterations:1000 Debug-seed:-1 Threads:4 Precision:3
# [ ][CORE][06/08/25-17:07:57][INFO] Running Real Analysis
# [ ][CORE][06/08/25-17:07:57][INFO] Running Statistical Analysis
# 100%|██████████| 1000/1000 [00:27<00:00, 35.87it/s][ ][CORE][06/08/25-17:08:25][INFO] Building Pvalues result
# [ ][CORE][06/08/25-17:08:25][INFO] Building results
# Saved deconvoluted to ../data/cpdb/NL\statistical_analysis_deconvoluted_08_06_2025_170825.txt
# Saved deconvoluted_percents to ../data/cpdb/NL\statistical_analysis_deconvoluted_percents_08_06_2025_170825.txt
# Saved means to ../data/cpdb/NL\statistical_analysis_means_08_06_2025_170825.txt
# 
# Warning in py_to_r.pandas.core.frame.DataFrame(<environment>) :
#   index contains duplicated values: row names not set
# Warning in py_to_r.pandas.core.frame.DataFrame(<environment>) :
#   index contains duplicated values: row names not set
# Saved pvalues to ../data/cpdb/NL\statistical_analysis_pvalues_08_06_2025_170825.txt
# Saved significant_means to ../data/cpdb/NL\statistical_analysis_significant_means_08_06_2025_170825.txt
# CellPhoneDB analysis completed successfully.
```







