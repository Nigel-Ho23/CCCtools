---
title: "Running CellPhoneDB in R"
output: github_document
date: "2025-08-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

CellPhoneDB is a popular **Python** package developed by [Teichmann Lab](https://www.teichlab.org/), and currently managed and further developed by the [Vento-Tormo Lab](https://ventolab.org/) from CellPhoneDB version 3. It is a useful cell-cell communication tool to directly look up interactions of interest from single-cell multiomics data, with their database of only manually curated and reviewed HUMAN interactions. 

A key feature of CellPhoneDB is its inherent function of accounting for heteromeric complexes by decomplexifying to their subunits and ensuring that expression of all subunits have to be non-zero and above a user-defined threshold to be considered present in the interaction. This accurately recapitulates how interactions can occur in vivo. As such, we thought to incorporate CellPhoneDB with another popular cell-cell communication tool, CellChat, that shares the same feature.

# Setting up required environment

As mentioned in the **Introduction**, CellPhoneDB is a Python package and currently, does not have an R equivalent. Here, we provide a wrapper function `run_cellphonedb()` for running CellPhoneDB completely within R. To do this, we require the use of the `reticulate` package (a dependency in CCCtools) and provide users with the `cpdb.yaml` file for creating the CellPhoneDB python environment in R.

## CellPhoneDB conda environment in R

### R set-up

```{r}
pacman::p_load_gh("nigelhojinker/CCCtools")
setwd(this.path::here())
rm(list = ls())
```

### Set up conda & python via reticulate

For users **WITHOUT** a prior conda installation, you may run the line below for installation of miniconda:

```{r, eval = FALSE}
if(!file.exists(conda_binary())) install_miniconda()
```

For users **WITH** conda installed previously, we can check that `reticulate` automatically detects the installed conda by running:

```{r, eval = FALSE}
conda_binary()
```

#### What if my conda installation is not automatically detected?

If conda is NOT automatically detected, we recommend running the line below to ensure that the correct conda is selected and used by `reticulate`. 
Of course, users should input the path to conda in their respective local machines.

```{r, eval = FALSE}
# We used miniforge for our conda installation
options(reticulate.conda_binary = "C:/path/to/miniforge3/condabin/conda.bat")
```

```{r, echo = FALSE}
options(reticulate.conda_binary = "C:/Users/hojkn/AppData/Local/miniforge3/condabin/conda.bat")
```

Once installation and conda selection is complete, we can confirm this by running:

```{r, eval = FALSE}
conda_binary()

## [1] "C:/path/to/miniforge3/condabin/conda.bat"
```

Next, we have to create the CellPhoneDB conda environment with the necessary Python modules for running the analysis.
This is done **only once**, and typically takes a few minutes to complete:

```{r, eval = FALSE}
config <- file.path( pacman::p_path("CCCtools"), "data/cpdb.yaml" )

conda_create(envname = "cpdb", environment = config)
```

Once the cpdb environment has been created, we have to select its python interpreter:

```{r, eval = FALSE}
python_binary <- conda_list() %>%
  filter(name == "cpdb") %>%
  pull(python) %>%
  normalizePath(winslash = "/")
```

```{r, eval = FALSE}
# Check right python interpreter selected
python_binary

## [1] "C:/path/to/miniforge3/envs/cpdb/python.exe"
```

```{r, eval = FALSE}
use_python(python_binary, required = TRUE)
```

# Running CellPhoneDB

Now, we are ready to run CellPhoneDB in R.

We provide the `run_cellphonedb()` function that can give us output from CellPhoneDB analysis ([method 2](https://github.com/ventolab/CellphoneDB/blob/master/notebooks/T1_Method2.ipynb)). `run_cellphonedb()` can take in the same arguments as its Python-based function, and users may refer to the linked "method 2" for details on what each argument does.

This function takes in a Seurat object with normalized counts in the data layer of the RNA assay and annotated cell type labels in its meta.data.

You may see [here](../R/run_cellphonedb.R) for full details of `run_cellphonedb()`.

```{r}
# Load your Seurat object
data(seu.NL)

seu.NL

seu.NL@meta.data %>% head()
```

## Running CellPhoneDB with all default parameters

Minimally, `run_cellphonedb()` takes in a Seurat object and the metadata column name corresponding to the annotated cell types. It creates a temporary directory (by default) that stores input files required to run CellPhoneDB, as well as the output .txt files from the analysis. Users may make a copy of the temporary directory for future use of the data if necessary.

```{r, eval = FALSE}

cpdb <- run_cellphonedb(obj = seu.NL, labels = "labels")

# use_dir is NULL. Creating temp directory for file creation and storage.
# Creating input and output files to directory: C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL 
#  Note: Make a copy of the temp directory (if applicable) for future use if necessary. 
# input_meta.tsv file created and saved to: C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL 
# input.h5ad file created and saved to: C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL 
# Reading user files...
# The following user files were loaded successfully:
# C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL/input.h5ad
# C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL/input_meta.tsv
# [ ][CORE][13/08/25-16:37:23][INFO] [Cluster Statistical Analysis] Threshold:0.1 Iterations:1000 Debug-seed:-1 Threads:4 Precision:3
# [ ][CORE][13/08/25-16:37:23][INFO] Running Real Analysis
# [ ][CORE][13/08/25-16:37:23][INFO] Running Statistical Analysis
# 100%|██████████| 1000/1000 [00:38<00:00, 25.86it/s][ ][CORE][13/08/25-16:38:02][INFO] Building Pvalues result
# [ ][CORE][13/08/25-16:38:02][INFO] Building results
# Saved deconvoluted to C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL\statistical_analysis_deconvoluted_08_13_2025_163802.txt
# Saved deconvoluted_percents to C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL\statistical_analysis_deconvoluted_percents_08_13_2025_163802.txt
# Saved means to C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL\statistical_analysis_means_08_13_2025_163802.txt
# Saved pvalues to C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL\statistical_analysis_pvalues_08_13_2025_163802.txt
# 
# CellPhoneDB analysis completed successfully.
# Warning messages:
# 1: In dir.create(prefix %>% normalizePath(winslash = "/"), recursive = TRUE) :
#   'C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi\seu.NL' already exists
# 2: In py_to_r.pandas.core.frame.DataFrame(<environment>) :
#   index contains duplicated values: row names not set
# 3: In py_to_r.pandas.core.frame.DataFrame(<environment>) :
#   index contains duplicated values: row names not set
# Saved significant_means to C:\Users\hojkn\AppData\Local\Temp\RtmpKixGIi/seu.NL\statistical_analysis_significant_means_08_13_2025_163802.txt
```

## Running CellPhoneDB with user-defined directory

Should users desire for the files to be created to their directory of choice, simply add the path to the directory of interest in the argument `use_dir`.

```{r, eval = FALSE}
cpdb <- run_cellphonedb(seu.NL, labels = "labels", use_dir = "cpdb/results")
```

## Running CellPhoneDB with adjustable parameters

```{r, eval = FALSE}
cpdb <- run_cellphonedb(seu.NL,
                        labels = "labels",
                        iterations = 123,
                        threshold = 0.2,
                        threads = 5,
                        debug_seed = 42,
                        result_precision = 5,
                        score_interactions = TRUE)
```
